<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SimuWeb - AI Website Builder</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {
      background:#000;
      color:#fff;
      font-family: "Inter", sans-serif;
      height:100vh; display:flex; flex-direction:column;
    }

    /* Workspace */
    .workspace {
      flex:1; display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .placeholder {
      text-align:center;
      color:#666;
      font-size:1.2rem;
    }
    iframe.preview {
      width:100%; height:100%; border:none; display:none;
    }

    /* Prompt bar */
    .prompt-bar {
      position:fixed;
      bottom:25px; left:50%; transform:translateX(-50%);
      background:#111; border:1px solid #333;
      border-radius:28px;
      padding:8px 12px;
      display:flex; align-items:center;
      width:650px; max-width:90%;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
    }
    .prompt-input {
      flex:1;
      background:transparent; border:none; outline:none;
      color:#fff; font-size:1rem;
      padding:10px 14px;
    }
    .prompt-btn {
      display:flex; align-items:center; justify-content:center;
      border:none; outline:none; cursor:pointer;
      background:#222; color:#fff;
      border-radius:20px; padding:8px 14px;
      font-size:0.9rem;
      transition:0.2s;
    }
    .prompt-btn:hover { background:#333; }

    /* Sidebar (right) */
    .sidebar {
      position:fixed;
      right:0; top:0; bottom:0;
      width:250px;
      background:#111;
      border-left:1px solid #333;
      display:flex; flex-direction:column;
    }
    .sidebar-header {
      padding:15px;
      border-bottom:1px solid #333;
      display:flex; align-items:center; gap:10px;
    }
    .avatar {
      width:36px; height:36px;
      border-radius:50%;
      background:#333; background-size:cover; background-position:center;
    }
    .username { font-size:0.95rem; color:#fff; }
    .projects {
      flex:1; overflow-y:auto; padding:15px;
    }
    .project-item {
      padding:10px;
      border:1px solid #333;
      border-radius:6px;
      margin-bottom:10px;
      cursor:pointer;
    }
    .project-item:hover { background:#1a1a1a; }
  </style>
</head>
<body>

<!-- Workspace -->
<div class="workspace">
  <div id="placeholder" class="placeholder">
    nothing here..<br>
    <small>Your AI website will appear here</small>
  </div>
  <iframe id="previewFrame" class="preview"></iframe>
</div>

<!-- Prompt Bar -->
<div class="prompt-bar">
  <input id="promptInput" class="prompt-input" placeholder="Describe your website idea..."/>
  <button id="generateBtn" class="prompt-btn" onclick="generateProject()">Generate</button>
</div>

<!-- Sidebar (right) -->
<div class="sidebar">
  <div class="sidebar-header" id="authArea">
    <button onclick="connectDiscord()" style="display:flex;align-items:center;gap:8px;background:#5865f2;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;color:#fff;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
        <path d="M20.317 4.3698a19.7913..."/>
      </svg>
      Sign in
    </button>
  </div>
  <div class="projects" id="projectsList">
    <!-- Projects appear here -->
  </div>
</div>

<script>
const clientId="YOUR_DISCORD_CLIENT_ID";
const redirectUri=window.location.origin;
const GROQ_API_KEY="YOUR_GROQ_API_KEY"; // set in vercel env

let userData=null, projects={}, projectCounter=1;

function connectDiscord(){
  const url=`https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=identify`;
  window.location.href=url;
}

window.onload=async()=>{
  if(window.location.hash.includes("access_token")){
    const params=new URLSearchParams(window.location.hash.substring(1));
    const token=params.get("access_token");
    const res=await fetch("https://discord.com/api/users/@me",{headers:{Authorization:`Bearer ${token}`}});
    userData=await res.json();
    loginSuccess(userData);
    window.history.replaceState({},document.title,redirectUri);
  }
};

function loginSuccess(user){
  document.getElementById("authArea").innerHTML=`
    <div class="avatar" style="background-image:url(https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png)"></div>
    <div class="username">${user.username}</div>
  `;
}

function saveProject(id, code){
  projects[id].versions.push(code);
  localStorage.setItem("simuweb-projects", JSON.stringify(projects));
  renderProjects();
}

function renderProjects(){
  const list=document.getElementById("projectsList");
  list.innerHTML="";
  Object.keys(projects).forEach(pid=>{
    const latest=projects[pid].versions.length;
    const el=document.createElement("div");
    el.className="project-item";
    el.innerText=`${pid} (v${latest})`;
    el.onclick=()=>loadProject(pid,latest);
    list.appendChild(el);
  });
}

function loadProject(pid,version){
  const code=projects[pid].versions[version-1];
  document.getElementById("placeholder").style.display="none";
  const frame=document.getElementById("previewFrame");
  frame.style.display="block";
  frame.srcdoc=code;
  const url=`${window.location.origin}/@${userData?.username||"guest"}/${pid}/${version}`;
  window.history.pushState({}, "", url);
}

async function generateProject(){
  const prompt=document.getElementById("promptInput").value.trim();
  if(!prompt) return;

  const btn=document.getElementById("generateBtn");
  btn.innerText="Crafting your site..";
  btn.disabled=true;

  const pid="proj"+projectCounter++;
  projects[pid]={versions:[]};

  try{
    const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+GROQ_API_KEY
      },
      body:JSON.stringify({
        model:"qwen/qwen3-32b",
        messages:[{role:"user",content:`Generate a complete HTML/CSS/JS site for: ${prompt}`}],
        temperature:0.7
      })
    });
    const data=await res.json();
    const code=data.choices[0].message.content;
    saveProject(pid, code);
    loadProject(pid,1);
  }catch(e){
    alert("Error: "+e.message);
  }

  btn.innerText="Generate";
  btn.disabled=false;
}
</script>
</body>
</html>
