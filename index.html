<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SimuWeb — AI Website Builder</title>
  <style>
    :root{
      --bg:#0c0c0c;
      --panel:#131313;
      --panel-2:#161616;
      --border:#2a2a2a;
      --text:#f5f5f5;
      --muted:#9aa0a6;
      --accent:#5865f2; /* Discord blue */
    }
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      background:var(--bg); color:var(--text);
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:flex; flex-direction:column;
    }

    /* ===== Auth (center card) ===== */
    .center{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{
      width:min(360px,92vw);
      background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:28px; text-align:center;
      box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    .brand{font-weight:800;font-size:1.45rem;margin-bottom:8px;letter-spacing:.2px}
    .tagline{color:var(--muted);font-size:.96rem;margin-bottom:22px}
    .discord-btn{
      width:100%; display:flex; align-items:center; justify-content:center; gap:12px;
      background:var(--accent); color:#fff; border:0; cursor:pointer;
      padding:12px 14px; border-radius:10px; font-weight:700; font-size:1rem;
      transition:transform .06s ease, filter .2s ease;
    }
    .discord-btn:hover{filter:saturate(105%) brightness(1.03)}
    .discord-btn:active{transform:translateY(1px)}
    .discord-logo{width:22px;height:22px;object-fit:contain}

    /* ===== App layout ===== */
    #app{display:none;flex:1;min-height:0}
    .workspace{
      position:relative; height:100%;
      display:grid; grid-template-columns:1fr 260px; /* content | right sidebar */
    }

    /* Main preview area */
    .stage{position:relative; display:flex; align-items:center; justify-content:center; background:var(--bg)}
    .placeholder{text-align:center;color:#6d7175;user-select:none}
    .placeholder h2{font-size:1.28rem;font-weight:800;margin-bottom:6px;opacity:.92}
    .placeholder p{font-size:.92rem;color:#8a8f95}
    .preview{position:absolute; inset:0; border:0; display:none; background:#fff}

    /* Right sidebar (projects / profile) */
    .right{background:var(--panel-2); border-left:1px solid var(--border); display:flex; flex-direction:column; min-height:0}
    .profile{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--border)}
    .avatar{width:36px;height:36px;border-radius:50%;background:#2a2a2a;background-size:cover;background-position:center}
    .uname{font-weight:700;font-size:.95rem}
    .toolbar{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    .btn{
      flex:1; text-align:center; background:#1e1e1e;
      border:1px solid var(--border); color:#e9e9e9;
      border-radius:10px; padding:8px 10px; font-weight:700; cursor:pointer; font-size:.9rem;
    }
    .btn:hover{background:#232323}
    .projects{flex:1;overflow:auto;padding:12px 10px 18px}
    .empty-list{color:#7a7f85;font-size:.9rem;padding:14px 10px}
    .proj{
      padding:10px 12px;border:1px solid var(--border);border-radius:10px;
      background:var(--panel);cursor:pointer;
      font-size:.92rem;display:flex;align-items:center;justify-content:space-between;
      transition:background .15s ease, border-color .15s ease; margin:8px 4px;
    }
    .proj:hover{background:#1a1a1a;border-color:#3a3a3a}
    .pill{color:#aab0b6;border:1px solid #3a3a3a;border-radius:999px;padding:2px 8px;font-size:.78rem}

    /* Floating prompt bar */
    .dock{
      position:fixed; left:50%; bottom:26px; transform:translateX(-50%);
      width:min(780px,94vw);
      background:#131313; border:1px solid var(--border);
      border-radius:999px; display:none; align-items:center; gap:8px;
      padding:6px 8px; box-shadow:0 18px 60px rgba(0,0,0,.45);
    }
    .input{flex:1;background:transparent;border:0;outline:0;color:var(--text);padding:12px 16px;font-size:1rem}
    .go{
      appearance:none;border:1px solid #3a3a3a;background:#242424;color:#fff;
      padding:10px 16px;border-radius:22px;font-weight:700;cursor:pointer;
      transition:background .15s ease,border-color .15s ease, transform .06s ease;
    }
    .go:hover{background:#2c2c2c;border-color:#4a4a4a}
    .go:active{transform:translateY(1px)}
    .thinking{display:none;align-items:center;gap:8px;margin-left:8px;color:#c7cad0;font-size:.9rem}
    .dots{display:inline-flex;gap:2px}
    .dot{width:6px;height:6px;border-radius:50%;background:#c7cad0;opacity:.35;animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}
    .dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    @media (max-width:980px){
      .workspace{grid-template-columns:1fr}
      .right{position:fixed;inset:auto 0 0 0;height:54vh;border-left:0;border-top:1px solid var(--border)}
      .projects{padding-bottom:24vh}
    }
  </style>
</head>
<body>

<!-- ===== Sign in ===== -->
<div id="login" class="center">
  <div class="card" role="dialog" aria-labelledby="ttl" aria-describedby="tag">
    <div class="brand" id="ttl">SimuWeb</div>
    <div class="tagline" id="tag">Build AI-crafted websites — fast, simple, smart.</div>
    <button class="discord-btn" id="discordBtn" type="button">
      <img class="discord-logo" alt="Discord"
           src="https://static.vecteezy.com/system/resources/previews/018/930/500/non_2x/discord-logo-discord-icon-transparent-free-png.png"/>
      Sign in with Discord
    </button>
  </div>
</div>

<!-- ===== App ===== -->
<div id="app">
  <div class="workspace">
    <!-- main stage -->
    <div class="stage">
      <div id="empty" class="placeholder">
        <h2>Nothing to see here yet</h2>
        <p>Your site will appear after you submit a prompt.</p>
      </div>
      <iframe id="frame" class="preview"></iframe>
    </div>

    <!-- right sidebar -->
    <aside class="right">
      <div class="profile">
        <div id="avatar" class="avatar" aria-hidden="true"></div>
        <div id="uname" class="uname" aria-live="polite"></div>
      </div>

      <div class="toolbar">
        <button id="newProject" class="btn" type="button">New Project</button>
      </div>

      <div id="list" class="projects">
        <div class="empty-list">No projects yet</div>
      </div>
    </aside>
  </div>
</div>

<!-- prompt dock -->
<div id="dock" class="dock">
  <div id="thinking" class="thinking" aria-live="polite">
    <span>Crafting your site</span>
    <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>
  </div>
  <input id="prompt" class="input" placeholder="Describe your website idea…" autocomplete="off" />
  <button id="go" class="go" type="button">Generate</button>
</div>

<script>
/* ---------- Config ---------- */
const DISCORD_CLIENT_ID = "1362097275811135669"; // your real client id
const REDIRECT_URI = window.location.origin;     // must be added in Discord Redirects

/* ---------- State ---------- */
let user = null;                // { id, username, avatar }
let projects = {};              // { [projectId]: [{version, code}] }
let currentProjectId = null;

/* ---------- DOM helpers ---------- */
const $ = id => document.getElementById(id);
function showBlock(el){ el.style.display = "block"; }
function showFlex(el){ el.style.display = "flex"; }
function hide(el){ el.style.display = "none"; }

/* ---------- Discord Auth ---------- */
$("discordBtn").onclick = () => {
  const url = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
  window.location.href = url;
};

window.addEventListener("load", async () => {
  // Handle redirect with access_token
  if (window.location.hash.includes("access_token")) {
    try{
      const params = new URLSearchParams(window.location.hash.substring(1));
      const token = params.get("access_token");
      const r = await fetch("https://discord.com/api/users/@me", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if(!r.ok) throw new Error("Discord identify failed");
      user = await r.json();

      // Clean URL hash
      history.replaceState({}, document.title, REDIRECT_URI);

      // Enter app view
      enterApp(user);
    }catch(e){
      console.error(e);
      alert("Discord sign-in failed. Check Client ID and Redirect URL in the Developer Portal.");
    }
  }
});

/* ---------- Enter App (fix for black screen) ---------- */
function enterApp(u){
  // ensure login hidden, app + dock visible with explicit display modes
  hide($("login"));
  showBlock($("app"));
  showFlex($("dock"));

  // profile
  $("uname").textContent = u.username || "User";
  const avatarUrl = (u.id && u.avatar)
    ? `https://cdn.discordapp.com/avatars/${u.id}/${u.avatar}.png`
    : "https://cdn.discordapp.com/embed/avatars/0.png";
  $("avatar").style.backgroundImage = `url(${avatarUrl})`;

  // start with an empty current project
  currentProjectId = null;

  // load existing projects (from server if you have an API; noop otherwise)
  refreshList();
}

/* ---------- Project creation ---------- */
$("newProject").onclick = () => {
  currentProjectId = "proj" + Date.now();
  if(!projects[currentProjectId]) projects[currentProjectId] = [];
  // focus prompt so user can start typing
  $("prompt").focus();
  // also update URL to project root (version will be appended on first generation)
  const uname = (user?.username || "guest").replace(/[^\w\-\.]/g,"_");
  history.pushState({}, "", `${window.location.origin}/@${uname}/${currentProjectId}`);
  refreshList();
};

/* ---------- Prompt UX ---------- */
$("prompt").addEventListener("keydown", (e)=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); $("go").click(); }
});
document.addEventListener("keydown",(e)=>{
  if(e.key==="F2"){ e.preventDefault(); $("prompt").focus(); }
});

/* ---------- Generate (AI) ---------- */
$("go").onclick = async () => {
  const text = $("prompt").value.trim();
  if(!text) return;

  // if no project yet, create one
  if(!currentProjectId){
    currentProjectId = "proj" + Date.now();
    projects[currentProjectId] = [];
  }

  // status UI
  $("go").disabled = true;
  $("go").textContent = "Crafting…";
  showFlex($("thinking"));

  try{
    // Preferred: server route that uses GROQ_API_KEY securely
    // Your /api/generate should return: { projectId, version, code }
    const resp = await fetch("/api/generate", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        prompt: text,
        username: user?.username || "guest",
        projectId: currentProjectId,
        model: "qwen/qwen3-32b"
      })
    });

    if (resp.ok){
      const data = await resp.json();
      applyGeneration(data);
    } else {
      // If API not ready, use client-side demo fallback so app still works
      throw new Error("Server not available; using demo fallback.");
    }

  }catch(err){
    console.warn(err.message);
    const version = (projects[currentProjectId]?.length || 0) + 1;
    const demo = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${text}</title><style>
      :root{--c:#111;--t:#111}
      body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;display:grid;place-items:center;height:100vh;margin:0}
      main{max-width:800px;padding:32px;border:1px solid #ddd;border-radius:14px}
      h1{margin:0 0 8px}
      p{margin:0;color:#444}
    </style></head><body><main>
      <h1>${text}</h1><p>Generated by SimuWeb (demo fallback)</p>
    </main></body></html>`;
    applyGeneration({ projectId: currentProjectId, version, code: demo });
  } finally {
    $("go").disabled = false;
    $("go").textContent = "Generate";
    hide($("thinking"));
  }
};

function applyGeneration({projectId, version, code}){
  if(!projects[projectId]) projects[projectId] = [];
  projects[projectId].push({version, code});

  // URL pattern /@username/projectId/version
  const uname = (user?.username || "guest").replace(/[^\w\-\.]/g,"_");
  history.pushState({}, "", `${window.location.origin}/@${uname}/${projectId}/${version}`);

  // Show in stage
  hide($("empty"));
  const frame = $("frame");
  frame.style.display = "block";
  frame.srcdoc = code;

  // Update list
  refreshList();
}

/* ---------- Project List ---------- */
function refreshList(){
  const root = $("list");
  root.innerHTML = "";
  const keys = Object.keys(projects);
  if(keys.length===0){
    const empty = document.createElement("div");
    empty.className = "empty-list";
    empty.textContent = "No projects yet";
    root.appendChild(empty);
    return;
  }
  keys.forEach(pid=>{
    const latest = projects[pid][projects[pid].length-1];
    const el = document.createElement("div");
    el.className = "proj";
    el.innerHTML = `<span>${pid}</span><span class="pill">v${latest.version}</span>`;
    el.onclick = ()=>{
      const v = latest.version;
      const uname = (user?.username || "guest").replace(/[^\w\-\.]/g,"_");
      history.pushState({}, "", `${window.location.origin}/@${uname}/${pid}/${v}`);
      hide($("empty"));
      const frame = $("frame");
      frame.style.display = "block";
      frame.srcdoc = latest.code;
      currentProjectId = pid;
    };
    root.appendChild(el);
  });
}
</script>
</body>
</html>
