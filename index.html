<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SimuWeb — AI Website Builder</title>
  <style>
    :root{--bg:#0c0c0c;--panel:#131313;--panel2:#161616;--border:#2a2a2a;--text:#f5f5f5;--muted:#9aa0a6;--accent:#5865f2;--ok:#24b47e;--err:#ff5c5c}
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:flex;flex-direction:column}
    .hidden{display:none!important}
    /* login */
    .center{flex:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:min(380px,92vw);background:#131313;border:1px solid var(--border);border-radius:16px;padding:28px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .brand{font-weight:800;font-size:1.55rem;margin-bottom:6px}
    .tagline{color:var(--muted);font-size:.96rem;margin-bottom:22px}
    .discord-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;background:var(--accent);color:#fff;border:0;cursor:pointer;padding:12px 14px;border-radius:10px;font-weight:700}
    .discord-logo{width:22px;height:22px;object-fit:contain}
    .badge{border:1px solid var(--border);padding:4px 10px;border-radius:999px;color:#c9cdd3;font-size:.84rem;display:inline-block;margin-top:14px}
    /* home */
    #route-login,#route-home,#route-builder{min-height:100%}
    .home{max-width:1100px;margin:0 auto;padding:28px 20px}
    .home-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .mini{display:flex;align-items:center;gap:10px}
    .avatar{width:36px;height:36px;border-radius:50%;background:#2a2a2a;background-size:cover;background-position:center}
    .uname{font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .tile{background:#161616;border:1px solid var(--border);border-radius:14px;padding:18px;min-height:130px;display:flex;flex-direction:column;gap:10px}
    .tile h3{font-size:1rem}.tile p{color:#a6abb0;font-size:.92rem}.tile .row{margin-top:auto;display:flex;gap:10px}
    .btn{background:#1e1e1e;border:1px solid var(--border);color:#e9e9e9;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:hover{background:#232323}.btn-primary{background:#2b2b2b;border-color:#3a3a3a}.btn-primary:hover{background:#323232}
    /* builder */
    .workspace{height:100%;display:grid;grid-template-columns:1fr 260px}
    .stage{position:relative;display:flex;align-items:center;justify-content:center;background:var(--bg)}
    .stage > .inner{position:relative;width:100%;height:100%}
    .ph{text-align:center;color:#6d7175}.ph h2{font-size:1.28rem;margin-bottom:6px}.ph p{font-size:.92rem;color:#8a8f95}
    .preview{position:absolute;left:0;top:0;width:100%;height:100%;border:0;display:none;background:#fff}
    .right{background:#161616;border-left:1px solid var(--border);display:flex;flex-direction:column;min-height:0}
    .profile{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--border)}
    .projects{flex:1;overflow:auto;padding:12px 10px 18px}
    .empty{color:#7a7f85;font-size:.9rem;padding:14px 10px}
    .proj{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#151515;display:flex;align-items:center;justify-content:space-between;margin:8px 4px;cursor:pointer}
    .proj:hover{background:#1b1b1b;border-color:#3a3a3a}
    .pill{border:1px solid #3a3a3a;border-radius:999px;padding:2px 8px;color:#aab0b6;font-size:.78rem}
    .tools{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    /* prompt */
    .dock{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);width:min(780px,94vw);background:#131313;border:1px solid var(--border);border-radius:999px;display:none;align-items:center;gap:8px;padding:6px 8px;box-shadow:0 18px 60px rgba(0,0,0,.45)}
    .input{flex:1;background:transparent;border:0;outline:0;color:#f5f5f5;padding:12px 16px;font-size:1rem}
    .go{appearance:none;border:1px solid #3a3a3a;background:#242424;color:#fff;padding:10px 16px;border-radius:22px;font-weight:700;cursor:pointer}
    .go:hover{background:#2c2c2c;border-color:#4a4a4a}
    .thinking{display:none;align-items:center;gap:8px;margin-left:8px;color:#c7cad0;font-size:.9rem}
    .dots{display:inline-flex;gap:2px}.dot{width:6px;height:6px;border-radius:50%;background:#c7cad0;opacity:.35;animation:blink 1.2s infinite ease-in-out}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.3;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}
    /* toasts */
    .toasts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:50}
    .toast{min-width:260px;max-width:min(420px,90vw);background:#161616;border:1px solid var(--border);border-left-width:3px;border-radius:12px;padding:12px 14px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
    .toast.ok{border-left-color:var(--ok)}.toast.err{border-left-color:var(--err)}
    .toast h4{margin:0 0 4px;font-size:.98rem}.toast p{margin:0;color:#c5c9cf;font-size:.92rem}
    @media (max-width:980px){.workspace{grid-template-columns:1fr}.right{position:fixed;inset:auto 0 0 0;height:54vh;border-left:0;border-top:1px solid var(--border)}.projects{padding-bottom:24vh}}
  </style>
</head>
<body>

<!-- LOGIN -->
<section id="route-login" class="center">
  <div class="card">
    <div class="brand">SimuWeb</div>
    <div class="tagline">Build AI-crafted websites — fast, simple, smart.</div>
    <button class="discord-btn" id="discordBtn" type="button">
      <img class="discord-logo" alt="Discord"
           src="https://static.vecteezy.com/system/resources/previews/018/930/500/non_2x/discord-logo-discord-icon-transparent-free-png.png"/>
      Sign in with Discord
    </button>
    <span class="badge">Early Access</span>
  </div>
</section>

<!-- HOME -->
<section id="route-home" class="hidden">
  <div class="home">
    <div class="home-h">
      <div class="mini">
        <div id="homeAvatar" class="avatar"></div>
        <div>
          <div id="homeName" class="uname">User</div>
          <div style="color:#8b9096;font-size:.85rem">Welcome back</div>
        </div>
      </div>
      <span class="badge">Early Access</span>
    </div>
    <div class="grid">
      <div class="tile">
        <h3>Start a project</h3><p>Describe what you want. SimuWeb crafts a working site with HTML, CSS, and JS.</p>
        <div class="row"><a class="btn btn-primary" id="startProject">Open builder</a></div>
      </div>
      <div class="tile"><h3>For You</h3><p>Personalized templates (coming soon).</p><div class="row"><button class="btn" disabled>Coming soon</button></div></div>
      <div class="tile"><h3>Newest</h3><p>Community projects (coming soon).</p><div class="row"><button class="btn" disabled>Coming soon</button></div></div>
    </div>
  </div>
</section>

<!-- BUILDER -->
<section id="route-builder" class="hidden">
  <div class="workspace">
    <div class="stage">
      <div class="inner">
        <div id="placeholder" class="ph"><h2>Nothing to see here yet</h2><p>Your site will appear after you submit a prompt.</p></div>
        <iframe id="frame" class="preview"></iframe>
      </div>
    </div>
    <aside class="right">
      <div class="profile">
        <div id="avatar" class="avatar"></div>
        <div>
          <div id="uname" class="uname">User</div>
          <div id="uid" style="color:#7f848a;font-size:.8rem"></div>
        </div>
      </div>
      <div class="tools"><button id="newProject" class="btn" type="button">New Project</button></div>
      <div id="list" class="projects"><div class="empty">No projects yet</div></div>
    </aside>
  </div>

  <div id="dock" class="dock">
    <div id="thinking" class="thinking"><span>Crafting your site</span><span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>
    <input id="prompt" class="input" placeholder="Describe your website idea…" autocomplete="off"/>
    <button id="go" class="go" type="button">Generate</button>
  </div>
</section>

<div id="toasts" class="toasts" aria-live="polite"></div>

<script>
/* ---------- public env ---------- */
let DISCORD_CLIENT_ID = null;

/* ---------- state ---------- */
let user = null; // { id, username, avatar, userId }
let currentProjectId = null;
const MODEL = "qwen/qwen3-32b";
const REDIRECT_URI = location.origin + location.pathname;

/* ---------- utils ---------- */
const $ = (id)=>document.getElementById(id);
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }
function toast(kind,title,msg){ const t=document.createElement('div'); t.className=`toast ${kind}`; t.innerHTML=`<h4>${title}</h4><p>${msg||""}</p>`; $('toasts').appendChild(t); setTimeout(()=>t.remove(),6000); }
function uid(){return "u_"+Math.random().toString(36).slice(2)+Date.now().toString(36)}
function sanitize(s){return (s||"").replace(/[^\w\-.]/g,"_")}
function saveSession(u){ try{localStorage.setItem("simuweb:user",JSON.stringify(u));}catch{} }
function loadSession(){ try{const r=localStorage.getItem("simuweb:user");return r?JSON.parse(r):null;}catch{return null;} }
function go(path){ history.pushState({}, "", path); renderRoute(); }

/* ---------- router ---------- */
function renderRoute(){
  const p = location.pathname;
  const isHome = p.endsWith("/home") || p === "/home";
  const isBuilder = /\/@/.test(p) || p.endsWith("/builder");
  hide($('route-login')); hide($('route-home')); hide($('route-builder'));
  if(!user){ show($('route-login')); return; }
  if(isHome){ show($('route-home')); return; }
  if(isBuilder){ show($('route-builder')); $('dock').style.display='flex'; return; }
  go("/home");
}

/* ---------- env + auth bootstrap ---------- */
async function initEnv(){
  try{ DISCORD_CLIENT_ID = (await fetch("/api/env").then(r=>r.json())).discordClientId; }catch{}
}
function hydrateUserUI(){
  const url = (user.id && user.avatar) ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : "https://cdn.discordapp.com/embed/avatars/0.png";
  $('homeAvatar').style.backgroundImage=`url(${url})`;
  $('homeName').textContent=user.username||'User';
  $('avatar').style.backgroundImage=`url(${url})`;
  $('uname').textContent=user.username||'User';
  $('uid').textContent=user.userId||'';
}
async function refreshIndex(){
  try{
    const userKey = encodeURIComponent(user?.userId || user?.username);
    const idx = await fetch(`/api/projects?userKey=${userKey}`).then(r=>r.json());
    renderProjectIndex(idx);
  }catch{ renderProjectIndex([]); }
}
function renderProjectIndex(list){
  const root = $('list'); root.innerHTML = '';
  if(!list || !list.length){ const e=document.createElement('div'); e.className='empty'; e.textContent='No projects yet'; root.appendChild(e); return; }
  list.forEach(p=>{
    const el=document.createElement('div'); el.className='proj';
    el.innerHTML=`<span>${p.projectId}</span><span class="pill">v${p.lastVersion}</span>`;
    el.onclick = async ()=>{
      const res = await fetch(`/api/projects?userKey=${encodeURIComponent(user?.userId || user?.username)}&projectId=${encodeURIComponent(p.projectId)}&version=${encodeURIComponent(p.lastVersion)}`);
      const manifest = await res.json();
      await renderManifestToPreview(manifest);
      const uname = sanitize(user?.username || 'guest');
      history.pushState({}, "", `${location.origin}/@${uname}/${p.projectId}/${p.lastVersion}`);
      currentProjectId = p.projectId;
    };
    root.appendChild(el);
  });
}

/* ---------- manifest bundler (NO raw text, full-size preview) ---------- */
async function bundleManifest(manifest){
  if(!manifest || !manifest.files){ // plain html string fallback
    return { html: String(manifest || '<!doctype html><title>Empty</title>') };
  }
  const map = new Map(manifest.files.map(f=>[f.name, f.content]));
  const entry = manifest.entry || 'index.html';
  let entryHtml = map.get(entry) || [...map.entries()].find(([n])=>n.endsWith('.html'))?.[1] || '<!doctype html><title>Empty</title>';

  // Force proper HTML doc
  if(!/^<!doctype html>/i.test(entryHtml.trim())) entryHtml = "<!doctype html>\n"+entryHtml;

  const parser = new DOMParser();
  const doc = parser.parseFromString(entryHtml, 'text/html');

  // inline CSS
  doc.querySelectorAll('link[rel="stylesheet"][href]').forEach(link=>{
    const href = link.getAttribute('href');
    const css = map.get(href);
    if(css!=null){ const style = doc.createElement('style'); style.textContent = css; link.replaceWith(style); }
  });

  // inline JS
  doc.querySelectorAll('script[src]').forEach(script=>{
    const src = script.getAttribute('src');
    const js = map.get(src);
    if(js!=null){ const s = doc.createElement('script'); const t=script.getAttribute('type'); if(t) s.type=t; s.textContent = js; script.replaceWith(s); }
  });

  // images → Blob URLs
  const mime = (n)=>({png:'image/png',jpg:'image/jpeg',jpeg:'image/jpeg',gif:'image/gif',svg:'image/svg+xml',webp:'image/webp'})[n.split('.').pop().toLowerCase()]||'application/octet-stream';
  doc.querySelectorAll('img[src]').forEach(img=>{
    const src = img.getAttribute('src');
    if(map.has(src)){ const url = URL.createObjectURL(new Blob([map.get(src)],{type:mime(src)})); img.setAttribute('src', url); }
  });

  const html = '<!DOCTYPE html>\n' + doc.documentElement.outerHTML;
  return { html };
}

async function renderManifestToPreview(manifest){
  const { html } = await bundleManifest(manifest);
  $('placeholder').classList.add('hidden');
  const f = $('frame'); f.style.display='block'; f.srcdoc = html; // full width/height by CSS
}

function showWriteProgress(files){
  const root = $('list'); root.innerHTML = '';
  (files||[]).forEach(f=>{
    const row=document.createElement('div'); row.className='proj';
    row.innerHTML=`<span>Writing ${f.name}</span><span class="pill">…</span>`;
    root.appendChild(row);
  });
}

/* ---------- deep-link loader ---------- */
async function maybeLoadDeepLink(){
  const parts = location.pathname.split('/').filter(Boolean);
  if(parts[0]?.startsWith('@') && parts.length>=3){
    const usernameInUrl = parts[0].slice(1);
    const pid = parts[1]; const ver = parts[2];
    if(!user) return;
    try{
      const res = await fetch(`/api/projects?userKey=${encodeURIComponent(user?.userId || usernameInUrl)}&projectId=${encodeURIComponent(pid)}&version=${encodeURIComponent(ver)}`);
      if(res.ok){ const manifest = await res.json(); if(manifest?.files?.length){ await renderManifestToPreview(manifest); show($('route-builder')); $('dock').style.display='flex'; currentProjectId = pid; } }
    }catch{}
  }
}

/* ---------- actions ---------- */
async function bootstrap(){
  // env + session
  try{ DISCORD_CLIENT_ID = (await fetch("/api/env").then(r=>r.json())).discordClientId; }catch{}
  const ses = loadSession();
  if(ses){ user = ses; hydrateUserUI(); go('/home'); await refreshIndex(); await maybeLoadDeepLink(); }
  else { renderRoute(); }

  $('discordBtn').onclick = ()=>{
    if(!DISCORD_CLIENT_ID){ toast('err','Missing config','DISCORD_CLIENT_ID not available.'); return; }
    const url = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
    location.href = url;
  };
  $('startProject').onclick = ()=>{ go('/builder'); $('dock').style.display='flex'; createNewProject(); $('prompt').focus(); };
  $('newProject').onclick = createNewProject;
  $('prompt').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();$('go').click();} });
  document.addEventListener('keydown',e=>{ if(e.key==='F2'){ e.preventDefault(); $('prompt').focus(); } });

  // oauth callback
  if(location.hash.includes('access_token')){
    try{
      const params = new URLSearchParams(location.hash.substring(1));
      const token = params.get('access_token');
      const r = await fetch('https://discord.com/api/users/@me',{headers:{Authorization:`Bearer ${token}`}});
      if(!r.ok) throw new Error('Discord identify failed');
      const d = await r.json();
      user = { id:d.id, username:d.username, avatar:d.avatar, userId:uid() };
      saveSession(user);
      history.replaceState({}, document.title, REDIRECT_URI);
      hydrateUserUI(); go('/home'); toast('ok','Signed in','Welcome to SimuWeb!');
      await refreshIndex(); await maybeLoadDeepLink();
    }catch(e){ console.error(e); toast('err','Sign-in failed','Try again. If this persists, contact support.'); renderRoute(); }
  }

  window.addEventListener('popstate', renderRoute);
}

function createNewProject(){
  currentProjectId = "proj" + Date.now();
  const uname = sanitize(user?.username || 'guest');
  history.replaceState({}, "", `${location.origin}/@${uname}/${currentProjectId}`);
  renderProjectIndex([]); // empty until first version
}

$('go').onclick = async ()=>{
  const text = $('prompt').value.trim();
  if(!text) return;
  if(!currentProjectId) createNewProject();

  $('go').disabled=true; $('go').textContent='Crafting…'; $('thinking').style.display='flex';
  try{
    const res = await fetch('/api/generate', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ prompt:text, username:user?.username||'guest', userId:user?.userId||user?.username, projectId:currentProjectId, model:MODEL })
    });
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json(); // { projectId, version, manifest }
    showWriteProgress(data.manifest?.files || []);
    await new Promise(r=>setTimeout(r, 350)); // let the progress be seen
    await renderManifestToPreview(data.manifest);

    const uname = sanitize(user?.username || 'guest');
    history.pushState({}, "", `${location.origin}/@${uname}/${data.projectId}/${data.version}`);
    await refreshIndex();
    toast('ok','Site ready','Preview updated.');
  }catch(err){
    console.error(err);
    toast('err','We hit a snag','Please try again. If this continues, contact support.');
  }finally{
    $('go').disabled=false; $('go').textContent='Generate'; $('thinking').style.display='none';
  }
};

window.onload = bootstrap;
</script>
</body>
</html>
